<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Certificado de Afiliación</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --verde-primario: #4CAF50;
      --verde-secundario: #388E3C;
      --amarillo-primario: #FFC107;
      --amarillo-secundario: #FFA000;
      --gris-claro: #f5f5f5;
      --gris-oscuro: #424242;
      --blanco: #ffffff;
      --rojo-primario: #f44336;
      --azul-primario: #2196F3;
      --morado-primario: #9C27B0;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, var(--verde-primario), var(--amarillo-primario));
      min-height: 100vh;
      padding: 20px;
      
    }
    
    .header {
      
      padding: 1.5rem;
      border-radius: 12px;
      
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      
      text-justify: auto;
      align-items: center;
    }
    
    .organization-name {
      color: var(--gris-oscuro);
      font-weight: 700;
      font-size: 1.2rem;
      line-height: 1.4;
      margin-bottom: 10px;
    }
    
    .current-date {
      color: #616161;
      font-size: 0.9rem;
    }
    
    .logo {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      width: 100%;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .logo i {
      font-size: 2.5rem;
      color: var(--verde-primario);
      background: linear-gradient(to right, var(--verde-primario), var(--amarillo-primario));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align: center;
    }
    
    .logo h1 {
      color: #2a2a2a;
      font-weight: 700;
      font-size: 1.5rem;
      line-height: 1.3;
      margin: 10px 0;
    }
    
    .logo .current-date {
      color: #424242;
      font-size: 1rem;
      font-weight: 500;
    }
    
    .actions-container {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      width: 100%;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .btn-primary {
      background: linear-gradient(to right, var(--verde-primario), var(--amarillo-primario));
      color: var(--blanco);
    }
    
    .btn-primary:hover {
      background: linear-gradient(to right, var(--verde-secundario), var(--amarillo-secundario));
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .btn-danger {
      background-color: var(--rojo-primario);
      color: var(--blanco);
    }
    
    .btn-danger:hover {
      background-color: #d32f2f;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .btn-info {
      background-color: var(--azul-primario);
      color: var(--blanco);
    }
    
    .btn-info:hover {
      background-color: #1976D2;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .btn-secondary {
      background-color: #757575;
      color: var(--blanco);
    }
    
    .btn-secondary:hover {
      background-color: #616161;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .btn-purple {
      background-color: var(--morado-primario);
      color: var(--blanco);
    }
    
    .btn-purple:hover {
      background-color: #7B1FA2;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .form-container {
      background-color: var(--blanco);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      margin: 0 auto;
      margin-bottom: 20px;
      width: 100%;
      max-width: 500px;
    }
    
    .form-container h2 {
      color: var(--gris-oscuro);
      margin-bottom: 15px;
      text-align: center;
    }
    
    .form-container input[type="text"] {
      width: 100%;
      padding: 12px 15px;
      margin: 8px 0;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s;
      background-color: var(--gris-claro);
      color: var(--gris-oscuro);
    }
    
    .form-container input[type="text"]:focus {
      border-color: var(--verde-primario);
      outline: none;
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
      background-color: var(--blanco);
    }
    
    .button-group {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    
    .botones-principal {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin: 20px auto;
      width: 100%;
      max-width: 800px;
    }
    
    .botones-secundarios {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      width: 100%;
    }
    
    .hidden {
      display: none !important;
    }
    
    /* CERTIFICADO - ESTILOS */
    #contenido-certificado {
      font-family: Tahoma, sans-serif;
      width: 210mm;
      min-height: 260mm;
      margin: 20px auto;
      padding: 10mm 20mm;
      background-image: url('https://raw.githubusercontent.com/carlos2601/certificados-afiliacion/main/logo.jpg');
      background-position: center 20%;
      background-repeat: no-repeat;
      background-size: contain;
      background-color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      box-sizing: border-box;
      position: relative;
      aspect-ratio: 210 / 297;
      display: none;
      overflow: hidden;
      transform-origin: top center;
    }
    
    /* Vista previa mejorada para móviles */
    @media screen and (max-width: 768px) {
      #contenido-certificado {
        transform: scale(0.7);
        margin: 20px auto 40px;
        overflow-x: auto;
      }
      
      .botones-secundarios {
        flex-direction: column;
        align-items: center;
      }
      
      .botones-secundarios button {
        width: 100%;
        max-width: 300px;
      }
    }
    
    /* Contenedor imagen certificado */
    #certificado-imagen-container {
      display: none;
      max-width: 100%;
      margin: 20px auto;
      text-align: center;
    }
    
    #certificado-imagen {
      max-width: 100%;
      height: auto;
      border: 1px solid #ddd;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    
    .encabezado-certificado {
      text-align: center;
      font-size: 17px;
      line-height: 1.4;
      margin-bottom: 20px;
      margin-top: 0;
    }
    
    .texto-justificado {
      text-align: justify;
      font-size: 9px;
      line-height: 1.5;
      margin: 0px 0;
    }
    
    .titulo-certificado {
      text-align: center;
      font-size: 18px;
      line-height: 1.5;
      margin: 30px 0;
    }
    
    .datos-certificado {
      text-align: left;
      font-size: 16px;
      line-height: 1.6;
      margin: 20px 0;
    }
    
    .firma-fondo {
      width: 270px;
      position: absolute;
      bottom: 25mm;
      left: 50%;
      transform: translateX(-50%);
    }
    
    .sello-derecha {
      width: 140px;
      position: absolute;
      bottom: 55mm;
      right: 20mm;
    }
    
    .sello2-fondo {
      width: 180px;
      position: absolute;
      bottom: 45mm;
      left: 50%;
      transform: translateX(-50%);
    }
    
    .pie-certificado {
      position: absolute;
      bottom: 20mm;
      width: calc(100% - 40mm);
      text-align: center;
      font-size: 12px;
    }
    
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
    }
    
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media print {
      body * {
        visibility: hidden;
      }
      #contenido-certificado, #contenido-certificado * {
        visibility: visible;
      }
      #contenido-certificado {
        position: absolute;
        left: 0;
        top: 0;
        width: 210mm;
        height: 297mm;
        margin: 0;
        padding: 10mm 20mm;
        box-shadow: none;
        transform: none !important;
      }
    }
  </style>
</head>
<body>

  <div class="logo">
    <i class="fas fa-certificate"></i>
    <h1>JUNTA DE ACCIÓN COMUNAL<br>BARRIO BATEAS SECTOR 3</h1>
    <div class="current-date" id="currentDate"></div>
  </div>
  
  <br><br>

  <div class="loading-overlay" id="loading-overlay">
    <div class="spinner"></div>
    <p>Generando certificado...</p>
  </div>



  <form id="formulario" class="form-container">
    <h2>Buscar documento</h2>
    <input type="text" id="cedula" placeholder="Número de cédula o Nombre" required />
    <button type="submit" class="btn btn-primary">Consultar</button>
  </form>

  <div id="formulario-edicion" class="form-container hidden">
    <h3>Editar Datos del Certificado</h3>
    <label for="editar-nombre">Nombre:</label>
    <input type="text" id="editar-nombre">
    
    <label for="editar-cedula">Cédula:</label>
    <input type="text" id="editar-cedula">
    
    <label for="editar-fecha">Fecha de Afiliación:</label>
    <input type="text" id="editar-fecha">
    
    <label for="editar-registro">Registro Nº:</label>
    <input type="text" id="editar-registro">
    
    <label for="editar-folio">Folio Nº:</label>
    <input type="text" id="editar-folio">
    
    <label for="editar-renglon">Renglón Nº:</label>
    <input type="text" id="editar-renglon">
    
    <label for="editar-direccion">Dirección:</label>
    <input type="text" id="editar-direccion">
    
    <div class="button-group">
      <button id="boton-guardar" class="btn btn-primary">Guardar Cambios</button>
      <button id="boton-aplicar-cambios" class="btn btn-primary hidden">Aplicar Cambios</button>
      <button id="boton-cancelar-edicion" class="btn btn-secondary">Cancelar</button>
    </div>
  </div>

  <div class="botones-principal">
    <button id="boton-opciones" class="btn btn-info">
      <i class="fas fa-cog"></i> Opciones
    </button>
    <button id="boton-ocultar-opciones" class="btn btn-info hidden">
      <i class="fas fa-times"></i> Ocultar Opciones
    </button>
    
    <div id="grupo-botones" class="hidden">
      <div class="botones-secundarios">
        <button id="boton-editar" class="btn btn-primary">
          <i class="fas fa-edit"></i> Editar
        </button>
        <button id="boton-vista-previa" class="btn btn-info">
          <i class="fas fa-eye"></i> Vista Previa
        </button>
        <button id="boton-ocultar-vista" class="btn btn-info hidden">
          <i class="fas fa-eye-slash"></i> Ocultar
        </button>
        <button id="boton-descarga" class="btn btn-purple">
          <i class="fas fa-download"></i> PNG
        </button>
        <button id="boton-pdf" class="btn btn-danger">
          <i class="fas fa-file-pdf"></i> PDF
        </button>
        <button id="boton-whatsapp" class="btn" style="background-color: #25D366; color: white;">
          <i class="fab fa-whatsapp"></i> WhatsApp
        </button>
        <button id="boton-volver" class="btn btn-secondary">
          <i class="fas fa-home"></i> Panel
        </button>
      </div>
    </div>
  </div>

  <div class="form-container hidden" id="whatsapp-control">
    <button class="btn btn-danger" onclick="document.getElementById('whatsapp-control').classList.add('hidden')" style="position: absolute; right: 20px; top: 20px;">
      <i class="fas fa-times"></i>
    </button>
    <h3>Enviar por WhatsApp</h3>
    <input type="text" id="numero-whatsapp" placeholder="Número de celular (10 dígitos)" maxlength="10" />
    <div class="error-message" id="whatsapp-error" style="color: var(--rojo-primario); display: none; margin-top: 5px;">
      Ingrese un número válido de 10 dígitos
    </div>
    <div class="whatsapp-info" style="font-size: 0.8rem; color: #666; margin-top: 5px;">
      Solo números colombianos. Ejemplo: 3123456789
    </div>
    <button id="confirmar-whatsapp" class="btn" style="background-color: #25D366; color: white; margin-top: 15px;">
      <i class="fab fa-whatsapp"></i> Enviar Certificado
    </button>
  </div>

  <!-- Certificado (oculto inicialmente) -->
  <div id="contenido-certificado">
    <div class="encabezado-certificado">
      <br>
      <strong>REPUBLICA DE COLOMBIA</strong><br>
      <strong>DEPARTAMENTO DEL META</strong><br>
      <strong>PUERTO GAITÁN – META</strong><br>
      <strong>JUNTA DE ACCIÓN COMUNAL</strong><br>
      <strong>ASENTAMIENTO HUMANO BATEAS</strong><br>
      Personería Jurídica No. 101 del 20 de noviembre de 2.012.
    </div>
    <div class="texto-justificado">
      El suscrito presidente del asentamiento humano Bateas, del Municipio de Puerto Gaitán Meta, fundamentado en la ley 1551 del 2012 que modifica el artículo 91 de la ley 136 de 1994, el cual reza en su artículo 91: Funciones. Los Alcaldes ejercerán…y además de estas, en el literal F numeral 6. Con relación a la prosperidad integral de su región; Expedirá la certificación para acreditar la residencia a aquellas personas que residen  en el territorio del área de influencia de los proyectos de exploración y explotación petrolera y minería en general, y que aspiren acceder a labores como mano de  obra no calificada y calificada, Los alcaldes expedirán dichos certificados con base en LOS REGISTROS ELECTORALES O DE SISBEN , ASI COMO LOS REGISTROS DE LOS AFILIADOS DE LAS JUNTAS DE ACCIÓN COMUNAL
    </div>

    <div class="titulo-certificado">
      <span style="font-size:18px;">CONSTANCIA DE AFILIACIÓN</span><br>
      <strong>La Junta de Acción Comunal del Barrio Bateas</strong><br>
      HACE CONSTAR:<br>
      Que la información suministrada reposa en el libro de afiliados:
    </div>

    <div class="datos-certificado">
      NOMBRE: <strong id="nombre-cert"></strong><br>
      CÉDULA: <strong id="cedula-cert"></strong><br>
      FECHA DE AFILIACIÓN: <strong id="fecha-cert"></strong><br>
      REGISTRO Nº: <strong id="registro-cert"></strong><br>
      FOLIO Nº: <strong id="folio-cert"></strong><br>
      RENGLÓN Nº: <strong id="renglon-cert"></strong><br>
      DIRECCIÓN: <strong id="direccion-cert"></strong><br><br>
      La presente constancia se expide a solicitud del interesado, <strong id="fecha-emision"></strong> y tiene vigencia de 6 meses a partir de la fecha de su expedición.
    </div>
    <br>Atentamente,<br><br><br><br>

    <img src="https://raw.githubusercontent.com/carlos2601/certificados-afiliacion/main/sello.png" class="sello-derecha" alt="Sello">
    <img src="https://raw.githubusercontent.com/carlos2601/certificados-afiliacion/main/firma.png" class="firma-fondo" alt="Firma">
    <img src="https://raw.githubusercontent.com/carlos2601/certificados-afiliacion/main/sello2.png" class="sello2-fondo" alt="Sello">

    <div style="text-align:center;margin-top:30px;">
      __________________________<br>
      <strong>JUAN CARLOS USECHE B</strong><br>
      Presidente<br>
      jacbateasgaitan@gmail.com
    </div>
    <br><br>
    <div style="text-align:justify;font-size:12px;line-height:1.3;margin-top:25px;"><br><br>
      Código penal colombiano. "ley 599 de 2000 art. 287.falsedad material en documento público, el que falsifique documentos públicos que pueda servir de prueba, incurrirá en prisión de 3 a 6 años". 
    </div>
  </div>

  <!-- Vista previa (oculta inicialmente) -->
  <div id="certificado-imagen-container" class="hidden">
    <img id="certificado-imagen" src="" alt="Vista previa del certificado">
  </div>

<script>
  // Configuración Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCERQc8srBtLuMe6Jw944WsO1mySohMpkU",
    authDomain: "junta-bateas-sector-3.firebaseapp.com",
    databaseURL: "https://junta-bateas-sector-3-default-rtdb.firebaseio.com",
    projectId: "junta-bateas-sector-3",
    storageBucket: "junta-bateas-sector-3.appspot.com",
    messagingSenderId: "913958453084",
    appId: "1:913958453084:web:5324de6958dfff01980b99"
  };

  // Inicializar Firebase
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
  const { jsPDF } = window.jspdf;

  // Variables globales
  let personaEncontrada = null;
  let datosOriginales = null;
  let certificadoCanvas = null;

  // Mostrar fecha actual
  function updateDateTime() {
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const today = new Date();
    document.getElementById('currentDate').textContent = today.toLocaleDateString('es-ES', options);
  }

  // Mostrar loader
  function mostrarLoader() {
    document.getElementById('loading-overlay').style.display = 'flex';
  }

  // Ocultar loader
  function ocultarLoader() {
    document.getElementById('loading-overlay').style.display = 'none';
  }

  // Función para formatear cédula
  function formatearCedula(cedula) {
    if (!cedula) return '';
    return cedula.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  // Función para formatear fecha
  function formatearFecha(fecha) {
    if (!fecha) return '';
    const date = new Date(fecha);
    if (isNaN(date)) return fecha;
    return date.toLocaleDateString('es-CO');
  }

  // Cargar datos desde Firebase
  function cargarDatos() {
    return new Promise((resolve, reject) => {
      database.ref('afiliaciones').once('value')
        .then((snapshot) => {
          const data = snapshot.val();
          resolve(data ? Object.values(data) : []);
        })
        .catch(reject);
    });
  }

  // Mostrar certificado
  function mostrarCertificado(persona) {
    document.getElementById("nombre-cert").textContent = persona.nombre;
    document.getElementById("cedula-cert").textContent = formatearCedula(persona.cedula);
    document.getElementById("fecha-cert").textContent = formatearFecha(persona.fecha);
    document.getElementById("registro-cert").textContent = formatearCedula(persona.registro);
    document.getElementById("folio-cert").textContent = persona.folio;
    document.getElementById("renglon-cert").textContent = persona.renglon;
    document.getElementById("direccion-cert").textContent = persona.direccion;
    document.getElementById("fecha-emision").textContent = formatearFecha(new Date());
    
    datosOriginales = {...persona};
    
    document.getElementById("editar-nombre").value = persona.nombre;
    document.getElementById("editar-cedula").value = persona.cedula;
    document.getElementById("editar-fecha").value = persona.fecha;
    document.getElementById("editar-registro").value = persona.registro;
    document.getElementById("editar-folio").value = persona.folio;
    document.getElementById("editar-renglon").value = persona.renglon;
    document.getElementById("editar-direccion").value = persona.direccion;
    
    document.getElementById("boton-opciones").classList.remove('hidden');
    document.getElementById("contenido-certificado").style.display = 'none';
  }

  // Buscar persona
  document.getElementById("formulario").addEventListener("submit", async function(e) {
    e.preventDefault();
    const cedula = document.getElementById("cedula").value.trim();
    
    try {
      mostrarLoader();
      const baseDatos = await cargarDatos();
      const persona = baseDatos.find(p => 
        String(p.cedula).replace(/\D/g, '') === cedula.replace(/\D/g, '') || 
        p.nombre.toLowerCase().includes(cedula.toLowerCase())
      );

      if (!persona) throw new Error("No se encontró el documento");
      
      personaEncontrada = persona;
      mostrarCertificado(persona);
      ocultarLoader();
    } catch (error) {
      alert(error.message);
      ocultarLoader();
    }
  });

  // Mostrar/ocultar opciones
  document.getElementById("boton-opciones").addEventListener("click", function() {
    this.classList.add('hidden');
    document.getElementById("boton-ocultar-opciones").classList.remove('hidden');
    document.getElementById("grupo-botones").classList.remove('hidden');
  });

  document.getElementById("boton-ocultar-opciones").addEventListener("click", function() {
    this.classList.add('hidden');
    document.getElementById("boton-opciones").classList.remove('hidden');
    document.getElementById("grupo-botones").classList.add('hidden');
  });

  document.getElementById('boton-volver').addEventListener('click', () => {
    if (confirm('¿Volver al menú principal?')) {
      window.location.href = 'panelprincipal.html';
    }
  });

  // Vista previa mejorada
  document.getElementById("boton-vista-previa").addEventListener("click", async function() {
    try {
      mostrarLoader();
      
      const certificado = document.getElementById("contenido-certificado");
      certificado.style.width = '210mm';
      certificado.style.height = '297mm';
      certificado.style.transform = 'scale(1)';
      
      certificado.style.display = 'block';
      document.getElementById("certificado-imagen-container").classList.add('hidden');
      
      this.classList.add('hidden');
      document.getElementById("boton-ocultar-vista").classList.remove('hidden');
      
      setTimeout(() => {
        certificado.scrollIntoView({ behavior: 'smooth', block: 'center' });
        ocultarLoader();
      }, 300);
      
    } catch (error) {
      alert("Error al generar vista previa: " + error.message);
      ocultarLoader();
    }
  });

  // Ocultar vista previa
  document.getElementById("boton-ocultar-vista").addEventListener("click", function() {
    document.getElementById("contenido-certificado").style.display = 'none';
    this.classList.add('hidden');
    document.getElementById("boton-vista-previa").classList.remove('hidden');
  });

  // Editar certificado
  document.getElementById("boton-editar").addEventListener("click", function() {
    document.getElementById("formulario-edicion").classList.remove('hidden');
    document.getElementById("boton-guardar").classList.remove('hidden');
    document.getElementById("boton-aplicar-cambios").classList.add('hidden');
  });

  document.getElementById("boton-cancelar-edicion").addEventListener("click", function() {
    document.getElementById("formulario-edicion").classList.add('hidden');
    if (datosOriginales) {
      mostrarCertificado(datosOriginales);
    }
  });

  // Guardar cambios
  document.getElementById("boton-guardar").addEventListener("click", function() {
    document.getElementById("boton-guardar").classList.add('hidden');
    document.getElementById("boton-aplicar-cambios").classList.remove('hidden');
  });

  // Aplicar cambios
  document.getElementById("boton-aplicar-cambios").addEventListener("click", function() {
    personaEncontrada.nombre = document.getElementById("editar-nombre").value;
    personaEncontrada.cedula = document.getElementById("editar-cedula").value;
    personaEncontrada.fecha = document.getElementById("editar-fecha").value;
    personaEncontrada.registro = document.getElementById("editar-registro").value;
    personaEncontrada.folio = document.getElementById("editar-folio").value;
    personaEncontrada.renglon = document.getElementById("editar-renglon").value;
    personaEncontrada.direccion = document.getElementById("editar-direccion").value;
    
    mostrarCertificado(personaEncontrada);
    document.getElementById("formulario-edicion").classList.add('hidden');
    alert("Cambios aplicados correctamente");
  });

  // Función mejorada para capturar certificado
  async function capturarCertificado(formato = 'png') {
    const elemento = document.getElementById("contenido-certificado");
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    // Mostrar temporalmente el certificado
    elemento.style.display = 'block';
    
    // Guardar estilos originales
    const originalStyles = {
      width: elemento.style.width,
      height: elemento.style.height,
      position: elemento.style.position,
      left: elemento.style.left,
      top: elemento.style.top,
      transform: elemento.style.transform
    };
    
    // Fijar dimensiones absolutas para captura
    elemento.style.width = '210mm';
    elemento.style.height = '297mm';
    elemento.style.position = 'absolute';
    elemento.style.left = '0';
    elemento.style.top = '0';
    elemento.style.transform = 'none';
    
    const options = {
      scale: isMobile ? 3 : 2,
      width: 210 * 3.78,
      height: 297 * 3.78,
      logging: true,
      useCORS: true,
      allowTaint: true,
      backgroundColor: '#FFFFFF',
      scrollX: 0,
      scrollY: 0,
      ignoreElements: (element) => {
        return element.id === 'loading-overlay';
      }
    };
    
    try {
      const canvas = await html2canvas(elemento, options);
      return canvas;
    } finally {
      // Restaurar estilos originales
      elemento.style.width = originalStyles.width;
      elemento.style.height = originalStyles.height;
      elemento.style.position = originalStyles.position;
      elemento.style.left = originalStyles.left;
      elemento.style.top = originalStyles.top;
      elemento.style.transform = originalStyles.transform;
      
      // Ocultar el certificado original
      elemento.style.display = 'none';
    }
  }

  // Descargar PNG mejorado
  document.getElementById("boton-descarga").addEventListener("click", async function() {
  try {
    mostrarLoader();
    const canvas = certificadoCanvas || await capturarCertificado('png');
    const ctx = canvas.getContext('2d');

    // Dibuja la marca de agua (opaca y centrada)
    ctx.fillStyle = 'rgba(100, 100, 100, 0.3)'; // Gris más visible
    ctx.font = 'bold 30px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.save();
    ctx.rotate(-20 * Math.PI / 180);
    ctx.fillText('CERTIFICADO OFICIAL', canvas.width / 2, canvas.height / 2);
    ctx.restore();

    // Descarga
    const link = document.createElement('a');
    link.href = canvas.toDataURL('image/png');
    link.download = `certificado_${personaEncontrada.cedula}.png`;
    link.click();
  } catch (error) {
    alert("Error: " + error.message);
  } finally {
    ocultarLoader();
  }
});

  // Descargar PDF mejorado
  document.getElementById("boton-pdf").addEventListener("click", async function() {
    try {
      mostrarLoader();
      const canvas = await capturarCertificado('pdf');
      const pdf = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
      });

      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = pdf.internal.pageSize.getHeight();
      
      pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
      
      // Protección básica
      pdf.setProperties({
        title: `Certificado de Afiliación - ${personaEncontrada.nombre}`,
        subject: 'Certificado de Afiliación',
        author: 'Junta de Acción Comunal Barrio Bateas Sector 3',
        keywords: 'certificado, afiliación, junta de acción comunal',
        creator: 'Sistema de Certificados JAC Bateas'
      });
      
      try {
        pdf.setEncryption({
          userPassword: 'bateas123',
          ownerPassword: 'bateas123',
          userPermissions: ['print', 'modify', 'copy', 'annot-forms']
        });
      } catch (e) {
        console.log("No se pudo proteger el PDF:", e);
      }
      
      pdf.save(`certificado_${personaEncontrada.cedula}.pdf`);
    } catch (error) {
      alert("Error al generar el PDF: " + error.message);
    } finally {
      ocultarLoader();
    }
  });

  // Validar número de WhatsApp
  function validarNumeroWhatsApp(numero) {
    const soloNumeros = numero.replace(/\D/g, '');
    return soloNumeros.length === 10 && /^3[0-9]{9}$/.test(soloNumeros);
  }

  // Mostrar/ocultar error de WhatsApp
  document.getElementById("numero-whatsapp").addEventListener("input", function() {
    const numero = this.value;
    const errorElement = document.getElementById("whatsapp-error");
    
    if (numero && !validarNumeroWhatsApp(numero)) {
      errorElement.style.display = 'block';
    } else {
      errorElement.style.display = 'none';
    }
  });

  // Enviar por WhatsApp
  document.getElementById("boton-whatsapp").addEventListener("click", function() {
    document.getElementById("whatsapp-control").classList.remove('hidden');
  });

  document.getElementById("confirmar-whatsapp").addEventListener("click", async function() {
    const numeroInput = document.getElementById("numero-whatsapp");
    const numero = numeroInput.value.trim();
    
    if (!validarNumeroWhatsApp(numero)) {
      document.getElementById("whatsapp-error").style.display = 'block';
      numeroInput.focus();
      return;
    }
    
    try {
      mostrarLoader();
      const canvas = await capturarCertificado('png');
      const imagenData = canvas.toDataURL('image/png', 0.95);
      
      const link = document.createElement('a');
      link.href = imagenData;
      link.download = `certificado_${personaEncontrada.cedula}.png`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      const numeroWhatsApp = `57${numero.replace(/\D/g, '')}`;
      window.open(`https://wa.me/${numeroWhatsApp}`, '_blank');
      
      alert("Por favor adjunte manualmente la imagen del certificado que se acaba de descargar.");
      
      document.getElementById("whatsapp-control").classList.add('hidden');
      numeroInput.value = '';
      
    } catch (error) {
      console.error("Error en WhatsApp:", error);
      alert("Ocurrió un error. Por favor intente nuevamente.");
    } finally {
      ocultarLoader();
    }
  });

  // Inicializar fecha actual
  updateDateTime();
</script>
</body>
</html>
